<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Shooting Game</title>
<style>
  body { margin:0; overflow:hidden; font-family:sans-serif; background:#222; }
  #ui { position:absolute; top:10px; left:10px; color:white; z-index:10; }
  #start-screen, #game-over-screen {
    position:absolute; inset:0; background:rgba(0,0,0,0.85); color:white;
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; z-index:10;
    text-align:center;
  }
  button { padding:10px 20px; font-size:16px; border:none; border-radius:6px; cursor:pointer; background:#4caf50; color:white; }
  select { padding:5px; font-size:16px; }
  #mobile-controls { position:absolute; bottom:20px; width:100%; display:flex; justify-content:center; gap:20px; z-index:10; }
  .control-btn { width:60px; height:60px; background:rgba(255,255,255,0.3); border-radius:50%; font-size:24px; text-align:center; line-height:60px; user-select:none; }
  .control-btn:active { background:rgba(255,255,255,0.6); }
</style>
</head>
<body>

<div id="ui">
  <div id="scoreboard">Score: 0</div>
  <div id="levelboard">Level: 1</div>
  <div id="livesboard">Lives: 3</div>
</div>

<div id="start-screen">
  <h2>3D Shooting Game</h2>
  <p id="instructions">Move: <b>A/D</b> | Shoot: <b>Left Click</b></p>
  <label>Select Gun:
    <select id="gunSelect">
      <option value="ak">AK-47</option>
      <option value="deagle">Deagle</option>
    </select>
  </label>
  <div id="gunPreview" style="width:300px;height:200px;margin-top:10px;"></div>
  <button id="start-btn">Start Game</button>
</div>

<div id="game-over-screen" style="display:none;">
  <h2>Game Over!</h2>
  <p id="final-score"></p>
  <button id="restart-btn">Restart</button>
</div>

<div id="mobile-controls" style="display:none;">
  <div id="left-btn" class="control-btn">◀</div>
  <div id="shoot-btn" class="control-btn">●</div>
  <div id="right-btn" class="control-btn">▶</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>

<script>
// --- Variables ---
let scene, camera, renderer;
let player, gunMesh, bullets=[], enemies=[];
let score=0, level=1, lives=3;
let running=false, keys={};
let ENEMY_SPEED=0.02, PLAYER_SPEED=0.2;
let lastEnemySpawnTime=0, ENEMY_INTERVAL=2500;
let gunType='ak', isMobile=false;

// UI Elements
const scoreboard=document.getElementById('scoreboard');
const levelboard=document.getElementById('levelboard');
const livesboard=document.getElementById('livesboard');
const startScreen=document.getElementById('start-screen');
const startBtn=document.getElementById('start-btn');
const gameOverScreen=document.getElementById('game-over-screen');
const finalScore=document.getElementById('final-score');
const restartBtn=document.getElementById('restart-btn');
const gunSelect=document.getElementById('gunSelect');
const mobileControls=document.getElementById('mobile-controls');
const leftBtn=document.getElementById('left-btn');
const rightBtn=document.getElementById('right-btn');
const shootBtn=document.getElementById('shoot-btn');
const instructions=document.getElementById('instructions');
const gunPreviewDiv=document.getElementById('gunPreview');

// --- Mobile Detection ---
function detectMobile(){
  isMobile = /Mobi|Android/i.test(navigator.userAgent);
  if(isMobile){
    mobileControls.style.display='flex';
    instructions.innerHTML="Use buttons to move & shoot";
  } else {
    instructions.innerHTML="Move: <b>A/D</b> | Shoot: <b>Left Click</b>";
  }
}

// --- Gun Preview ---
let previewScene, previewCamera, previewRenderer, previewGun;
function initGunPreview(){
  previewScene=new THREE.Scene();
  previewCamera=new THREE.PerspectiveCamera(75, gunPreviewDiv.clientWidth/gunPreviewDiv.clientHeight, 0.1, 1000);
  previewCamera.position.z=3;
  previewRenderer=new THREE.WebGLRenderer({alpha:true, antialias:true});
  previewRenderer.setSize(gunPreviewDiv.clientWidth, gunPreviewDiv.clientHeight);
  gunPreviewDiv.appendChild(previewRenderer.domElement);
  loadGunPreview();
  animatePreview();
}

function loadGunPreview(){
  if(previewGun) previewScene.remove(previewGun);
  previewGun=createGunMesh(gunType);
  previewGun.rotation.y=Math.PI/4;
  previewScene.add(previewGun);
}

function animatePreview(){
  requestAnimationFrame(animatePreview);
  if(previewGun) previewGun.rotation.y +=0.01;
  previewRenderer.render(previewScene, previewCamera);
}

// --- Create Gun Mesh ---
function createGunMesh(type){
  const group=new THREE.Group();
  if(type==='ak'){
    const barrel=new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,1), new THREE.MeshBasicMaterial({color:0x333333}));
    barrel.rotation.z=Math.PI/2;
    barrel.position.x=0.5;
    const body=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.1,0.2), new THREE.MeshBasicMaterial({color:0x222222}));
    body.position.x=-0.1;
    group.add(barrel);
    group.add(body);
  } else { // Deagle
    const barrel=new THREE.Mesh(new THREE.BoxGeometry(0.7,0.08,0.15), new THREE.MeshBasicMaterial({color:0x444444}));
    barrel.position.x=0.35;
    const handle=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.08,0.3), new THREE.MeshBasicMaterial({color:0x222222}));
    handle.position.x=-0.1; handle.position.y=-0.05;
    group.add(barrel);
    group.add(handle);
  }
  return group;
}

// --- Init Game ---
function initGame(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x222222);
  camera=new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.z=5;
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Room
  const floor=new THREE.Mesh(new THREE.BoxGeometry(10,0.1,10), new THREE.MeshBasicMaterial({color:0x555555}));
  floor.position.y=-2.5;
  scene.add(floor);
  const leftWall=new THREE.Mesh(new THREE.BoxGeometry(0.1,5,10), new THREE.MeshBasicMaterial({color:0x8888ff}));
  leftWall.position.x=-5;
  leftWall.position.y=0;
  scene.add(leftWall);
  const rightWall=new THREE.Mesh(new THREE.BoxGeometry(0.1,5,10), new THREE.MeshBasicMaterial({color:0x8888ff}));
  rightWall.position.x=5;
  rightWall.position.y=0;
  scene.add(rightWall);

  // Player
  player=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshBasicMaterial({color:0x0000ff}));
  player.position.y=-2;
  scene.add(player);

  // Gun
  gunMesh=createGunMesh(gunType);
  gunMesh.position.set(0,-2,0.3);
  scene.add(gunMesh);

  // Events
  window.addEventListener('resize',()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // Desktop shooting
  window.addEventListener('mousedown', e=>{
    if(!running) return;
    if(!isMobile && e.button===0) shootBullet();
  });

  // Mobile buttons
  leftBtn.addEventListener('touchstart', e=>keys['a']=true);
  leftBtn.addEventListener('touchend', e=>keys['a']=false);
  rightBtn.addEventListener('touchstart', e=>keys['d']=true);
  rightBtn.addEventListener('touchend', e=>keys['d']=false);
  shootBtn.addEventListener('touchstart', e=>shootBullet());
}

// --- Shoot Bullet ---
function shootBullet(){
  const bullet=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.3,0.1), new THREE.MeshBasicMaterial({color:0xffff00}));
  bullet.position.set(player.position.x, player.position.y+0.2, 0.3);
  bullets.push(bullet);
  scene.add(bullet);
}

// --- Keyboard ---
document.addEventListener('keydown', e=>{ if(!isMobile) keys[e.key.toLowerCase()]=true; });
document.addEventListener('keyup', e=>{ if(!isMobile) keys[e.key.toLowerCase()]=false; });

// --- Update Player ---
function updatePlayer(){
  if(keys['a']) player.position.x -= PLAYER_SPEED;
  if(keys['d']) player.position.x += PLAYER_SPEED;
  player.position.x = Math.max(-4.5, Math.min(4.5, player.position.x));
  if(gunMesh) gunMesh.position.x = player.position.x;
}

// --- Spawn Enemy ---
function spawnEnemy(){
  const enemy=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshBasicMaterial({color:0xff0000}));
  enemy.position.x=(Math.random()-0.5)*8;
  enemy.position.y=3;
  enemies.push(enemy);
  scene.add(enemy);
}

// --- Game Loop ---
let lastTime=0;
function animate(time){
  if(!running){ renderer.render(scene,camera); return; }
  requestAnimationFrame(animate);

  updatePlayer();

  // Spawn enemies
  if(time-lastEnemySpawnTime>ENEMY_INTERVAL){ spawnEnemy(); lastEnemySpawnTime=time; }

  // Move bullets
  bullets.forEach((b,i)=>{
    b.position.y+=0.12;
    if(b.position.y>3){ scene.remove(b); bullets.splice(i,1); }
  });

  // Move enemies and check collisions
  enemies.forEach((e,i)=>{
    e.position.y-=ENEMY_SPEED;
    bullets.forEach((b,j)=>{
      if(Math.abs(b.position.x-e.position.x)<0.3 && Math.abs(b.position.y-e.position.y)<0.3){
        scene.remove(b); bullets.splice(j,1);
        scene.remove(e); enemies.splice(i,1);
        score+=10;
        scoreboard.textContent='Score: '+score;
      }
    });
    if(e.position.y<-3){
      scene.remove(e); enemies.splice(i,1);
      lives--;
      livesboard.textContent='Lives: '+lives;
      if(lives<=0) endGame();
    }
  });

  // Level up
  let newLevel=Math.floor(score/100)+1;
  if(newLevel>level){
    level=newLevel;
    ENEMY_SPEED+=0.005;
    ENEMY_INTERVAL=Math.max(500,ENEMY_INTERVAL-100);
    levelboard.textContent='Level: '+level;
  }

  renderer.render(scene,camera);
}

// --- Start/Restart Game ---
function startGame(){
  detectMobile();
  if(!scene) initGame();
  score=0; level=1; lives=3;
  bullets.forEach(b=>scene.remove(b)); bullets=[];
  enemies.forEach(e=>scene.remove(e)); enemies=[];
  running=true;
  scoreboard.textContent='Score: 0';
  levelboard.textContent='Level: 1';
  livesboard.textContent='Lives: 3';
  startScreen.style.display='none';
  gameOverScreen.style.display='none';
  player.position.set(0,-2,0);
  gunMesh.position.set(0,-2,0.3);
  lastTime=0;
  animate(0);
}

function endGame(){
  running=false;
  finalScore.textContent='Your score: '+score;
  gameOverScreen.style.display='flex';
}

// Event Listeners
startBtn.addEventListener('click', startGame);
restartBtn.addEventListener('click', startGame);
gunSelect.addEventListener('change', ()=>{ gunType=gunSelect.value; loadGunPreview(); });

initGunPreview();
detectMobile();
</script>

</body>
</html>
